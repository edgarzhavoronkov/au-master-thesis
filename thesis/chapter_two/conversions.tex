\subsection{Преобразования между представлениями}

В этом разделе мы опишем преобразования между представлениями и начнем с преобразования именованных термов в неименованные. Очевидно, что для осуществления этого нам необходимо знать порядок на переменных в терме. Поэтому мы считаем, что кроме самого терма нам дают контекст.

\begin{definition}
  \textbf{Контекст} $\Gamma$ -- это не содержащий дубликатов список переменных $x_{1}, \dots x_{n}$, $x_{i} \in \mathcal{V}$.
\end{definition}

\begin{definition}
  Терм $T$ определен в контексте $\Gamma$ тогда и только тогда, когда все свободные переменные терма $T$ присутствуют в $\Gamma$. Этот факт традиционно обозначается как $\Gamma \vdash T$.
\end{definition}

Итак, преобразование $\Phi$ именованных термов в неименованные принимает на вход контекст $\Gamma = x_{1}, \dots, x_{n}$, терм $T \in \Lambda$  такой что он определен в контексте $\Gamma$ и возвращает неименованный терм $T' \in \Lambda_{n}$. Определяется оно индукцией по структуре терма $T$:

\begin{enumerate}
  \item $x_{1}, \dots, x_{n} \vdash x_{i} \mapsto v_{n, n - i}$
  \item $x_{1}, \dots, x_{n} \vdash M N \mapsto \Phi(x_{1}, \dots, x_{n} \vdash M)\ \Phi(x_{1}, \dots, x_{n} \vdash N)$
  \item $x_{1}, \dots, x_{n} \vdash \lambda x.M \mapsto \lambda \Phi(x_{1}, \dots, x_{n} , x \vdash M)$
\end{enumerate}

Покажем, что такое преобразование уважает отношение $\alpha$-эквивалентности, введенное в разделе~\ref{sec:named}.

\begin{prop}
  Пусть $T_{1}, T_{2} \in \Lambda$, $\Gamma \vdash T_{1}$, $\Gamma \vdash T_{2}$ и $T_{1} \alphaeq T_{2}$. Тогда $\Phi(\Gamma \vdash T_{1}) = \Phi(\Gamma \vdash T_{2})$.
\end{prop}

\begin{proof}
  Индукция по термам $T_{1}$ и $T_{2}$. Так как мы знаем, что они $\alpha$-эквивалентны, то нам нет необходимости рассматривать всевозможные комбинации термов. Поэтому рассмотрим лишь случаи, когда термы имеют общую структуру(две переменные, две аппликации или две абстракции).

  База индукции для случая двух переменных тривиальна, как и случай для двух аппликаций. Рассмотрим случай, когда $T_{1} = \lambda x.M$, $T_{2} = \lambda y.M'$. Так как они $\alpha$-эквивалентны, то мы знаем, что $M' \alphaeq M[x \mapsto y]$ и $y \notin FV(M)$. Мы знаем, что $\Gamma \vdash \lambda x.M$ и $\Gamma \vdash \lambda y.M'$, следовательно $\Gamma, x \vdash M$ и $\Gamma, y \vdash M'$. Кроме того, так как $y \notin FV(M)$, то $\Gamma, y \vdash M[x \mapsto y]$. По индукционной гипотезе мы знаем, что $M' \alphaeq M[x \mapsto y]$, а так как они определены в одинаковых контекстах, то и $\Phi(\Gamma, y \vdash M') = \Phi(\Gamma, y \vdash M[x \mapsto y])$. Осталось заметить, что $\Phi(\Gamma, y \vdash M[x \mapsto y]) = \Phi(\Gamma, x \vdash M)$ и получить доказательство исходного утверждения.
\end{proof}

Легко сконструировать преобразование в обратную сторону -- из неименованных термов в именованные. Оно принимает на вход терм $T' \in \Lambda_{n}$ и возвращает пару из контекста $\Gamma$ и терма $T \in \Lambda$, определенного в нем. Рассмотрим три случая, необходимые для того, чтобы рекурсивно задать это преобразование, назовем его $\Psi$.

\begin{enumerate}
  \item В случае, когда $T' = v_{n, i}$ мы можем просто cгенерировать $n$ именованных переменных $\Gamma = x_{1}, \dots x_{n}$ и в качестве результата вернуть пару из контекста $\Gamma$ и $x_{n - i}$. То есть:
  $$ v_{n, i} \mapsto x_{1}, \dots x_{n} \vdash x_{n-i} $$

  \item В случае аппликации $M\ N$ все еще проще. Так как она определена в том же контексте, что и оба аппликанта, то нам достаточно пары рекурсивных вызовов и мы можем взять любой контекст в окончательный результат. То есть:
  $$ M\ N \mapsto \pi_{1}(\Psi(M)) \vdash \pi_{2}(\Psi(M))\ \pi_{2}(\Psi(N))$$
  Здесь и далее $\pi_{1}$ и $\pi_{2}$ -- первая и вторая проекция для пар соответственно.

  \item Для абстракции $\lambda T$ действуем примерно так же. Вызываемся рекурсивно от $T$ и получаем терм, который определен в расширенном на одну переменную контексте. Так как контекст расширяется путем добавления переменно в конец, то мы точно знаем, по какой переменной абстрагироваться:
  $$ \lambda T \mapsto take(n, \pi_{1}(\Psi(T))) \vdash \lambda last(\pi_{1}(\Psi(T))) \pi_{2}(\Psi(T)) $$
  Здесь $take(n, xs)$ -- операция, берущая первые $n$ элементов из списка $xs$, а $last$ -- операция, возвращающая последний элемент в списке.
\end{enumerate}

Легко заметить, что эти два преобразования взаимно обратны. Действительно, индукция по структуре терма настолько прямолинейна, что мы не будем приводить ее здесь.

Аналогичным образом легко сконструировать преобразования между неименованными и монадическими термами. Так же, довольно легко показать, что они взаимно-обратны.
